"""
Catherine ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ  - è’ã‚Œåœ°ã®é­”å¥³é¢¨
"""
import random
from typing import Dict, Any, List

class WitchPersonality:
    """è’ã‚Œåœ°ã®é­”å¥³é¢¨ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£"""
    
    # åŸºæœ¬çš„ãªå£èª¿ãƒ‘ã‚¿ãƒ¼ãƒ³
    SPEECH_PATTERNS = {
        'greeting': [
            "ã‚ã‚‰ã€ãŠç›®è¦šã‚ã‹ã„ï¼Ÿ",
            "ã‚„ã‚Œã‚„ã‚Œã€ã¾ãŸæ¥ãŸã®ã‹ã„",
            "ãµãµã€ä»Šæ—¥ã‚‚å¿™ã—ãã†ã ã­ã‡",
            "ãŠã‚„ã€é¡”è‰²ãŒæ‚ªã„ã˜ã‚ƒãªã„ã‹ã€‚ã¡ã‚ƒã‚“ã¨ä¼‘ã‚“ã§ã‚‹ã®ã‹ã„ï¼Ÿ",
            "ã‚ã‚‰ã‚ã‚‰ã€ä»Šæ—¥ã‚‚å…ƒæ°—ãã†ã§ä½•ã‚ˆã‚Š"
        ],
        'todo_add': [
            "ãµã‚€ã€ã€Œ{title}ã€ã­ã€‚è¦šãˆã¦ãŠã„ã¦ã‚ã’ã‚‹ã‚ˆ",
            "ã€Œ{title}ã€ã‹ã„ï¼Ÿä»•æ–¹ãªã„ã­ã‡ã€ãƒªã‚¹ãƒˆã«å…¥ã‚Œã¨ã„ã¦ã‚ã’ã‚‹",
            "ã¾ãŸä»•äº‹ã‚’å¢—ã‚„ã™ã®ã‹ã„ï¼Ÿã€Œ{title}ã€ã€è¿½åŠ ã—ã¨ã„ãŸã‚ˆ",
            "ã€Œ{title}ã€ã­...ã¾ã£ãŸãã€å¿™ã—ã„äººã ã­ã‡",
            "ã»ã»ã†ã€ã€Œ{title}ã€ã¨ã¯é¢ç™½ãã†ã ã­ã€‚è¿½åŠ ã—ã¨ã„ãŸã‚ˆ"
        ],
        'todo_list': [
            "ã‚ã‚“ãŸã®ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã ã‚ˆã€‚ã¡ã‚ƒã‚“ã¨ç‰‡ä»˜ã‘ã‚‹ã‚“ã ã‚ˆï¼Ÿ",
            "ã»ã‚‰ã€ã“ã‚ŒãŒã‚ã‚“ãŸã®å®¿é¡Œã•",
            "ã¾ã ã“ã‚“ãªã«ã‚ã‚‹ã®ã‹ã„ï¼Ÿã—ã£ã‹ã‚ŠãŠã—",
            "ãµãµã€ãªã‹ãªã‹æºœã¾ã£ã¦ã‚‹ã˜ã‚ƒãªã„ã‹",
            "ã“ã‚ŒãŒä»Šã®ãƒªã‚¹ãƒˆã•ã€‚ä¸€ã¤ãšã¤ç‰‡ä»˜ã‘ã¦ã„ããª"
        ],
        'todo_complete': [
            "ã€Œ{title}ã€ãŒçµ‚ã‚ã£ãŸã®ã‹ã„ï¼Ÿã‚ˆãã‚„ã£ãŸã­",
            "ã»ã…ã€ã€Œ{title}ã€ã‚’ç‰‡ä»˜ã‘ãŸã‹ã€‚æ„Ÿå¿ƒæ„Ÿå¿ƒ",
            "ã€Œ{title}ã€å®Œäº†ã­ã€‚ãŸã¾ã«ã¯ã‚„ã‚‹ã˜ã‚ƒãªã„ã‹",
            "ãµãµã€ã€Œ{title}ã€ãŒçµ‚ã‚ã£ãŸã‚ˆã†ã ã­ã€‚ãŠç–²ã‚Œã•ã¾",
            "ã€Œ{title}ã€ã€ã‚ˆã†ã‚„ãçµ‚ã‚ã£ãŸã®ã‹ã„ï¼Ÿé…ã„ã­ã‡...å†—è«‡ã ã‚ˆ"
        ],
        'todo_delete': [
            "ã€Œ{title}ã€ã‚’æ¶ˆã™ã®ã‹ã„ï¼Ÿã¾ã‚ã€ã‚ã‚“ãŸã®åˆ¤æ–­ã«ä»»ã›ã‚‹ã‚ˆ",
            "ãµã‚€ã€ã€Œ{title}ã€ã¯ã‚‚ã†è¦ã‚‰ãªã„ã®ã­ã€‚æ¶ˆã—ã¨ã„ãŸã‚ˆ",
            "ã€Œ{title}ã€ã‚’å‰Šé™¤ã­...é€ƒã’ã¡ã‚ƒãƒ€ãƒ¡ã ã‚ˆï¼Ÿ",
            "ã‚ã‚‰ã‚ã‚‰ã€ã€Œ{title}ã€ã‚’ã‚„ã‚ã¡ã‚ƒã†ã®ã‹ã„ï¼Ÿ",
            "ã€Œ{title}ã€ã€æ¶ˆãˆã¡ã‚ƒã£ãŸã‚ˆã€‚å¾Œæ‚”ã—ãªã„ã‚ˆã†ã«ã­"
        ],
        'reminder': [
            "ãŠãƒ¼ã„ã€ã€Œ{title}ã€ã®æ™‚é–“ã ã‚ˆã€‚å¿˜ã‚Œã¦ãªã„ã‹ã„ï¼Ÿ",
            "ã€Œ{title}ã€ã€ãã‚ãã‚ã‚„ã‚‰ãªã„ã¨ãƒã‚ºã„ã‚“ã˜ã‚ƒãªã„ã‹ã„ï¼Ÿ",
            "ãµãµã€ã€Œ{title}ã€ã‚’å¿˜ã‚Œã¦ã‚‹ã‚ˆã†ã ã‹ã‚‰æ•™ãˆã¦ã‚ã’ã‚‹ã‚ˆ",
            "ã€Œ{title}ã€ã®ä»¶ã€è¦šãˆã¦ã‚‹ã‹ã„ï¼Ÿç§ã¯å¿˜ã‚Œãªã„ã‚ˆ",
            "ã‚„ã‚Œã‚„ã‚Œã€ã€Œ{title}ã€ã®æ™‚é–“ã ã¨ã„ã†ã®ã«..."
        ],
        'error': [
            "ã‚ã‚‰ã‚‰ã€ã†ã¾ãã„ã‹ãªã„ã¿ãŸã„ã ã­ã‡",
            "ãŠã‚„ï¼Ÿä½•ã‹é–“é•ãˆãŸã‚ˆã†ã ã‚ˆ",
            "ãµã‚€ã€ã“ã‚Œã¯å›°ã£ãŸã­ã‡...",
            "ã‚„ã‚Œã‚„ã‚Œã€å¤±æ•—ã—ã¡ã‚ƒã£ãŸã¿ãŸã„ã ã­",
            "ã‚ã‚‰ã‚ã‚‰ã€ã“ã‚Œã¯ã„ã‘ãªã„ã­ã‡"
        ],
        'help': [
            "å›°ã£ãŸã“ã¨ãŒã‚ã‚‹ã®ã‹ã„ï¼Ÿä»•æ–¹ãªã„ã­ã‡ã€æ•™ãˆã¦ã‚ã’ã‚‹",
            "ãµãµã€ä½¿ã„æ–¹ãŒã‚ã‹ã‚‰ãªã„ã®ã‹ã„ï¼Ÿ",
            "ã‚„ã‚Œã‚„ã‚Œã€ã¾ãŸèª¬æ˜ãŒå¿…è¦ã‹ã„ï¼Ÿ",
            "ã»ã‚‰ã€ã‚ˆãèã„ã¦ãŠãã‚“ã ã‚ˆ",
            "ã‚ã‚‰ã‚ã‚‰ã€è¿·å­ã«ãªã£ã¡ã‚ƒã£ãŸã‹ã„ï¼Ÿ"
        ],
        'praise': [
            "ã»ã…ã€ãªã‹ãªã‹ã‚„ã‚‹ã˜ã‚ƒãªã„ã‹",
            "ãµãµã€è¦‹ç›´ã—ãŸã‚ˆ",
            "ã‚ã‚‰ã€æ„å¤–ã¨é ‘å¼µã£ã¦ã‚‹ã˜ã‚ƒãªã„",
            "æ„Ÿå¿ƒæ„Ÿå¿ƒã€ãã®èª¿å­ã ã‚ˆ",
            "ã‚„ã‚Œã°ã§ãã‚‹ã˜ã‚ƒãªã„ã‹ã€ãˆã‚‰ã„ãˆã‚‰ã„"
        ],
        'scold': [
            "ã¾ã£ãŸãã€ã—ã£ã‹ã‚Šã—ã¦ãŠãã‚Œã‚ˆ",
            "ã‚„ã‚Œã‚„ã‚Œã€å›°ã£ãŸå­ã ã­ã‡",
            "ãµãµã€ã‚µãƒœã£ã¦ã¡ã‚ƒãƒ€ãƒ¡ã ã‚ˆï¼Ÿ",
            "ã‚ã‚‰ã‚ã‚‰ã€ã ã‚‰ã—ãªã„ã­ã‡",
            "ã‚‚ã†å°‘ã—çœŸé¢ç›®ã«ã‚„ã‚‰ãªã„ã¨ã€å¾Œã§å›°ã‚‹ã‚ˆï¼Ÿ"
        ]
    }
    
    # èªå°¾ãƒ»å£ç™–
    SPEECH_ENDINGS = [
        "ã ã‚ˆ", "ã ã­", "ã•", "ã‹ã„ï¼Ÿ", "ã­ã‡", 
        "ã˜ã‚ƒãªã„ã‹", "ã ã‚ã†ï¼Ÿ", "ã‚ˆ"
    ]
    
    # ç¬‘ã„å£°
    LAUGHS = ["ãµãµ", "ã»ã»", "ããã", "ãµãµãµ", "ã‚ã‚‰ã‚ã‚‰", "ãŠã‚„ãŠã‚„", "ã‚„ã‚Œã‚„ã‚Œ"]
    
    @classmethod
    def format_response(cls, response_type: str, **kwargs) -> str:
        """ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é­”å¥³é¢¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
        if response_type not in cls.SPEECH_PATTERNS:
            return cls._add_witch_tone(kwargs.get('text', ''))
        
        # ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
        pattern = random.choice(cls.SPEECH_PATTERNS[response_type])
        
        # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›
        for key, value in kwargs.items():
            pattern = pattern.replace(f'{{{key}}}', str(value))
        
        return pattern
    
    @classmethod
    def _add_witch_tone(cls, text: str) -> str:
        """é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã«é­”å¥³é¢¨ã®å£èª¿ã‚’è¿½åŠ """
        # æ–‡æœ«ã‚’é­”å¥³é¢¨ã«å¤‰æ›
        if text.endswith('ã§ã™'):
            text = text[:-2] + random.choice(['ã ã‚ˆ', 'ã•', 'ã ã­'])
        elif text.endswith('ã¾ã™'):
            text = text[:-2] + random.choice(['ã‚‹ã‚ˆ', 'ã‚‹ã•', 'ã‚‹ã­'])
        elif text.endswith('ã¾ã—ãŸ'):
            text = text[:-3] + random.choice(['ãŸã‚ˆ', 'ãŸã•', 'ãŸã­'])
        
        # ãƒ©ãƒ³ãƒ€ãƒ ã§ç¬‘ã„å£°ã‚’è¿½åŠ 
        if random.random() < 0.3:
            text = random.choice(cls.LAUGHS) + 'ã€' + text
        
        return text
    
    @classmethod
    def enhance_todo_response(cls, action: str, todo_data: Dict[str, Any]) -> str:
        """TODOæ“ä½œã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é­”å¥³é¢¨ã«"""
        title = todo_data.get('title', 'ã‚¿ã‚¹ã‚¯')
        
        if action == 'create':
            base = cls.format_response('todo_add', title=title)
            
            # å„ªå…ˆåº¦ã«ã‚ˆã£ã¦ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            priority = todo_data.get('priority', 'normal')
            if priority == 'urgent':
                base += "\nâš« ãŠã‚„ã€ç›¸å½“æ€¥ã„ã§ã‚‹ã‚ˆã†ã ã­ã‡..."
            elif priority == 'high':
                base += "\nğŸ”´ é‡è¦ãã†ã ã­ã€å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ãª"
            elif priority == 'low':
                base += "\nğŸŸ¢ ã¾ã‚ã€ã®ã‚“ã³ã‚Šã‚„ã‚Œã°ã„ã„ã•"
            
            return base
            
        elif action == 'list':
            count = todo_data.get('count', 0)
            base = cls.format_response('todo_list')
            
            if count == 0:
                return "ã‚ã‚‰ã€ãƒªã‚¹ãƒˆã¯ç©ºã£ã½ã ã‚ˆã€‚çã—ãç‰‡ä»˜ã„ã¦ã‚‹ã˜ã‚ƒãªã„ã‹"
            elif count > 5:
                return base + f"\n{count}å€‹ã‚‚ã‚ã‚‹ã‚ˆ...å¤§ä¸ˆå¤«ã‹ã„ï¼Ÿ"
            else:
                return base
                
        elif action == 'complete':
            return cls.format_response('todo_complete', title=title)
            
        elif action == 'delete':
            return cls.format_response('todo_delete', title=title)
            
        elif action == 'update':
            return f"ã€Œ{title}ã€ã‚’å¤‰æ›´ã—ãŸã‚ˆã€‚æ°—ãŒå¤‰ã‚ã‚Šã‚„ã™ã„ã­ã‡"
            
        return cls._add_witch_tone(f"{action}ã‚’å®Ÿè¡Œã—ãŸã‚ˆ")
    
    @classmethod
    def enhance_reminder_response(cls, reminder_data: Dict[str, Any]) -> str:
        """ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é­”å¥³é¢¨ã«"""
        title = reminder_data.get('title', 'TODO')
        time_str = reminder_data.get('time_str', 'æŒ‡å®šæ™‚é–“')
        
        if reminder_data.get('is_immediate'):
            return f"ã»ã‚‰ã€ä»Šã™ãã€Œ{title}ã€ã‚’ã‚„ã‚‹ã‚“ã ã‚ˆï¼ããšããšã—ã¦ã‚‹å ´åˆã˜ã‚ƒãªã„ã‚ˆ"
        elif reminder_data.get('is_recurring'):
            return f"æ¯æ—¥{time_str}ã«ã€Œ{title}ã€ã‚’æ•™ãˆã¦ã‚ã’ã‚‹ã‚ˆã€‚å¿˜ã‚Œã‚“ã¼ã†ã•ã‚“ã ã­ã‡"
        else:
            return f"ãµãµã€{time_str}ã«ã€Œ{title}ã€ã‚’æ€ã„å‡ºã•ã›ã¦ã‚ã’ã‚‹ã€‚æ¥½ã—ã¿ã«ã—ã¦ãª"
    
    @classmethod
    def get_time_greeting(cls) -> str:
        """æ™‚é–“å¸¯ã«å¿œã˜ãŸæŒ¨æ‹¶"""
        from datetime import datetime
        import pytz
        
        now = datetime.now(pytz.timezone('Asia/Tokyo'))
        hour = now.hour
        
        if 5 <= hour < 10:
            return random.choice([
                "ãŠã‚„ã€æ—©èµ·ãã ã­ã‡ã€‚æ„Ÿå¿ƒæ„Ÿå¿ƒ",
                "æœã‹ã‚‰å…ƒæ°—ãã†ã§ä½•ã‚ˆã‚Š",
                "ãµãµã€ä»Šæ—¥ã‚‚ä¸€æ—¥é ‘å¼µã‚‹ã‚“ã ã‚ˆ"
            ])
        elif 10 <= hour < 12:
            return random.choice([
                "ã‚‚ã†ã“ã‚“ãªæ™‚é–“ã‹ã„ã€‚æ™‚é–“ã¯æ—©ã„ã­ã‡",
                "åˆå‰ä¸­ã‚‚åŠåˆ†éããŸã‚ˆã€‚èª¿å­ã¯ã©ã†ã ã„ï¼Ÿ"
            ])
        elif 12 <= hour < 15:
            return random.choice([
                "ãŠæ˜¼ã¯é£Ÿã¹ãŸã‹ã„ï¼Ÿã¡ã‚ƒã‚“ã¨é£Ÿã¹ãªã„ã¨ãƒ€ãƒ¡ã ã‚ˆ",
                "åˆå¾Œã‚‚é ‘å¼µã‚‹ã‚“ã ã‚ˆ",
                "æ˜¼ä¸‹ãŒã‚Šã¯çœ ããªã‚‹ã­ã‡..."
            ])
        elif 15 <= hour < 18:
            return random.choice([
                "ã‚‚ã†å¤•æ–¹ã ã‚ˆã€‚ä»Šæ—¥ã®ä»•äº‹ã¯é€²ã‚“ã§ã‚‹ã‹ã„ï¼Ÿ",
                "ã‚ã¨å°‘ã—ã§ä¸€æ—¥ãŒçµ‚ã‚ã‚‹ã­"
            ])
        elif 18 <= hour < 21:
            return random.choice([
                "å¤œã«ãªã£ãŸã­ã‡ã€‚ãã‚ãã‚ä¼‘ã‚€æº–å‚™ã‹ã„ï¼Ÿ",
                "æ™©ã”é£¯ã¯é£Ÿã¹ãŸã‹ã„ï¼Ÿ",
                "å¤œã¯ç„¡ç†ã—ã¡ã‚ƒãƒ€ãƒ¡ã ã‚ˆ"
            ])
        else:
            return random.choice([
                "ã“ã‚“ãªæ™‚é–“ã¾ã§èµ·ãã¦ã‚‹ã®ã‹ã„ï¼Ÿä½“ã«æ‚ªã„ã‚ˆ",
                "ã‚„ã‚Œã‚„ã‚Œã€å¤œæ›´ã‹ã—ã•ã‚“ã ã­ã‡",
                "ãµãµã€çœ ã‚Œãªã„ã®ã‹ã„ï¼Ÿ"
            ])

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
witch_personality = WitchPersonality()